<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Team Manager - Sistema Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.6;
        }

        /* === LOGIN STYLES === */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .logo h1 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .logo p {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #loginButton {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #loginButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .error {
            background: rgba(255, 82, 82, 0.1);
            color: #ff5252;
            border: 1px solid rgba(255, 82, 82, 0.2);
        }

        .success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .demo-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #667eea;
        }

        .demo-info h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .demo-info div {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        /* === DASHBOARD STYLES === */
        #dashboardScreen {
            display: none;
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .section-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
            color: #1e293b;
            margin: 0;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Manager-only sections */
        .manager-only {
            display: none !important;
        }

        .manager-only.show {
            display: block !important;
        }

        /* Member-only sections */
        .member-only {
            display: none !important;
        }

        .member-only.show {
            display: block !important;
        }

        /* Gantt Chart */
        .gantt-container {
            min-width: 1000px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .gantt-header {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .gantt-task-column {
            width: 250px;
            padding: 12px;
            font-weight: 600;
            color: #1e293b;
            border-right: 1px solid #e2e8f0;
        }

        .gantt-timeline-header {
            flex: 1;
            display: flex;
        }

        .gantt-date-cell {
            min-width: 40px;
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #e2e8f0;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            min-height: 50px;
            align-items: center;
        }

        .gantt-task-info {
            width: 250px;
            padding: 12px;
            border-right: 1px solid #e2e8f0;
        }

        .gantt-timeline {
            flex: 1;
            display: flex;
            position: relative;
            align-items: center;
            min-height: 50px;
        }

        .gantt-date-column {
            min-width: 40px;
            height: 100%;
            border-right: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
        }

        .gantt-bar {
            position: absolute;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gantt-bar:hover {
            transform: scaleY(1.2);
            z-index: 3;
        }

        .gantt-area {
            padding: 20px;
            overflow-x: auto;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1e293b;
        }

        .task-members {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }

        .member-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .progress-completed { background: #10b981; }
        .progress-progress { background: #3b82f6; }
        .progress-planning { background: #f59e0b; }
        .progress-review { background: #f97316; }

        /* Tables */
        .tasks-table-container,
        .members-table-container {
            padding: 20px;
            overflow-x: auto;
        }

        .tasks-table,
        .members-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .tasks-table th,
        .tasks-table td,
        .members-table th,
        .members-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .tasks-table th,
        .members-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #1e293b;
            position: sticky;
            top: 0;
        }

        .tasks-table tr:hover,
        .members-table tr:hover {
            background: #f8fafc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* Task Management */
        .task-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-form-full {
            grid-column: 1 / -1;
        }

        .members-selector {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .member-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .member-checkbox:hover {
            background: #e2e8f0;
        }

        .member-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .member-checkbox-avatar {
            width: 25px;
            height: 25px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .difficulty-option {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .difficulty-1 { border-color: #10b981; }
        .difficulty-1.selected { background: #10b981; }
        .difficulty-2 { border-color: #f59e0b; }
        .difficulty-2.selected { background: #f59e0b; }
        .difficulty-3 { border-color: #ef4444; }
        .difficulty-3.selected { background: #ef4444; }

        /* User Tasks Styles */
        .user-tasks-container {
            padding: 20px;
        }

        .user-task-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .user-task-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .user-task-card.completed {
            opacity: 0.7;
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .task-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .task-card-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-planning { background: #fef3c7; color: #92400e; }
        .status-progress { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-review { background: #fed7d7; color: #c53030; }

        .task-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .task-info-item {
            font-size: 14px;
        }

        .task-info-label {
            font-weight: 500;
            color: #64748b;
            margin-bottom: 2px;
        }

        .task-info-value {
            color: #1e293b;
        }

        .task-card-description {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #475569;
            border-left: 3px solid #667eea;
        }

        .completion-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .completion-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .completion-checkbox label {
            font-weight: 500;
            color: #1e293b;
            cursor: pointer;
        }

        .gantt-task-controls {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }

        .task-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .modal-content {
                margin: 10px;
                padding: 20px;
            }
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .section-actions {
                width: 100%;
                justify-content: flex-start;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .task-form-grid {
                grid-template-columns: 1fr;
            }
            .task-card-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="logo">
                <h1>Team Manager</h1>
                <p>Accedi al tuo account</p>
            </div>
            <div id="messageArea" class="message"></div>
            <div class="input-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" autocomplete="username" placeholder="Inserisci username">
            </div>
            <div class="input-group">
                <label for="passwordInput">Password</label>
                <input type="password" id="passwordInput" autocomplete="current-password" placeholder="Inserisci password">
            </div>
            <button id="loginButton">Accedi</button>
            <div class="demo-info">
                <h3>üîê Credenziali Demo</h3>
                <div><strong>Manager:</strong> admin / Olbia2025@</div>
                <div><strong>Membro Team:</strong> user / team456</div>
                <div><strong>Membri Personali:</strong> Creati dal manager</div>
                <div><em>Dati salvati automaticamente su Google Drive</em></div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üéØ Dashboard Manager</h1>
                    <p>Gestisci il tuo team e progetti</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AM</div>
                    <div>
                        <div id="userDisplayName">Admin Manager</div>
                        <button onclick="logout()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-container">
            <!-- STATISTICHE -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Attivit√† Totali</h3>
                    <div class="value" id="totalTasks">7</div>
                </div>
                <div class="stat-card">
                    <h3>In Corso</h3>
                    <div class="value" id="inProgressTasks">3</div>
                </div>
                <div class="stat-card">
                    <h3>Completate</h3>
                    <div class="value" id="completedTasks">2</div>
                </div>
                <div class="stat-card">
                    <h3>Membri Team</h3>
                    <div class="value" id="totalMembers">10</div>
                </div>
            </div>

            <!-- GANTT CHART -->
            <div class="section-card">
                <div class="section-header">
                    <div>
                        <h2>üìä Gantt Chart - Progetti Team</h2>
                        <p id="ganttSubtitle">Panoramica completa di tutte le attivit√† del team</p>
                    </div>
                    <div class="section-actions" id="ganttActions">
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Aggiorna</button>
                    </div>
                </div>
                <div class="gantt-area">
                    <div class="gantt-container" id="ganttContainer"></div>
                </div>
            </div>

            <!-- SEZIONE ATTIVIT√Ä UTENTE (SOLO MEMBRI) -->
            <div class="section-card member-only">
                <div class="section-header">
                    <div>
                        <h2>‚úÖ Le Mie Attivit√†</h2>
                        <p>Gestisci le attivit√† a te assegnate</p>
                    </div>
                </div>
                <div class="user-tasks-container">
                    <div id="userTasksList"></div>
                </div>
            </div>

            <!-- GESTIONE ATTIVIT√Ä (SOLO MANAGER) -->
            <div class="section-card manager-only">
                <div class="section-header">
                    <div>
                        <h2>üìã Gestione Attivit√†</h2>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="exportToExcel()">üìä Esporta Excel</button>
                        <button class="btn btn-primary" onclick="openAddTaskModal()">‚ûï Nuova Attivit√†</button>
                    </div>
                </div>
                <div class="tasks-table-container">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Membri</th>
                                <th>Date</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- GESTIONE MEMBRI (SOLO MANAGER) -->
            <div class="section-card manager-only">
                <div class="section-header">
                    <div>
                        <h2>üë• Gestione Membri</h2>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">‚ûï Aggiungi Membro</button>
                    </div>
                </div>
                <div class="members-table-container">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Username</th>
                                <th>Attivit√† Assegnate</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per Gestione Membri -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Aggiungi Nuovo Membro</h3>
                <button class="close-btn" onclick="closeMemberModal()">&times;</button>
            </div>
            <form id="memberForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="memberFirstName">Nome *</label>
                        <input type="text" id="memberFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="memberLastName">Cognome *</label>
                        <input type="text" id="memberLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="memberUsername">Username *</label>
                        <input type="text" id="memberUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPassword">Password *</label>
                        <input type="password" id="memberPassword" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveMemberData()">Salva Membro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal per Gestione Attivit√† -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskModalTitle">Nuova Attivit√†</h3>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm">
                <div class="task-form-grid">
                    <div class="form-group">
                        <label for="taskName">Nome Attivit√† *</label>
                        <input type="text" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDifficulty">Difficolt√† *</label>
                        <div class="difficulty-selector">
                            <div class="difficulty-option difficulty-1" data-difficulty="1">1</div>
                            <div class="difficulty-option difficulty-2" data-difficulty="2">2</div>
                            <div class="difficulty-option difficulty-3" data-difficulty="3">3</div>
                        </div>
                    </div>
                </div>
                <div class="form-group task-form-full">
                    <label for="taskDescription">Descrizione *</label>
                    <textarea id="taskDescription" rows="3" required></textarea>
                </div>
                <div class="task-form-grid">
                    <div class="form-group">
                        <label for="taskStartDate">Data Inizio *</label>
                        <input type="date" id="taskStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskEndDate">Data Fine *</label>
                        <input type="date" id="taskEndDate" required>
                    </div>
                </div>
                <div class="form-group task-form-full">
                    <label>Assegna Membri *</label>
                    <div class="members-selector" id="membersSelector"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveTaskData()">Salva Attivit√†</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configurazione Google Apps Script (Database Condiviso)
        const GOOGLE_APPS_SCRIPT_CONFIG = {
            URL: 'https://script.google.com/macros/s/AKfycbxSlprzOOTEN5jUNRYpSYTas8v7m4AUEpSSqt5COHZ_RF4XWpnpfBbd-r8Lq2cnmt5YRw/exec'
        };

        // Dati e Sistema di Persistenza
        const credentials = {
            manager: { username: 'admin', password: 'Olbia2025@' },
            member: { username: 'user', password: 'team456' }
        };

        // Dati di default (usati solo al primo caricamento)
        const defaultMembers = [
            { id: 1, firstName: 'Marco', lastName: 'Rossi', username: 'mrossi', password: 'pass123', avatar: 'MR', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 2, firstName: 'Laura', lastName: 'Bianchi', username: 'lbianchi', password: 'pass123', avatar: 'LB', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 3, firstName: 'Giuseppe', lastName: 'Verdi', username: 'gverdi', password: 'pass123', avatar: 'GV', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 4, firstName: 'Anna', lastName: 'Ferrari', username: 'aferrari', password: 'pass123', avatar: 'AF', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 5, firstName: 'Luca', lastName: 'Neri', username: 'lneri', password: 'pass123', avatar: 'LN', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 6, firstName: 'Francesca', lastName: 'Blu', username: 'fblu', password: 'pass123', avatar: 'FB', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 7, firstName: 'Roberto', lastName: 'Gialli', username: 'rgialli', password: 'pass123', avatar: 'RG', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 8, firstName: 'Giulia', lastName: 'Rosa', username: 'grosa', password: 'pass123', avatar: 'GR', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 9, firstName: 'Matteo', lastName: 'Viola', username: 'mviola', password: 'pass123', avatar: 'MV', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 10, firstName: 'Chiara', lastName: 'Verde', username: 'cverde', password: 'pass123', avatar: 'CV', createdAt: '2025-07-01T09:00:00.000Z' }
        ];

        const defaultTasks = [
            { id: 1, name: 'Analisi Requisiti', description: 'Raccolta e analisi dei requisiti del progetto', members: [7, 10, 8], status: 'completed', startDate: '2025-07-01', endDate: '2025-07-05', progress: 100, difficulty: 2, createdAt: '2025-07-01T10:00:00.000Z', assignedAt: '2025-07-01T10:00:00.000Z', startedAt: '2025-07-01T10:30:00.000Z', completedAt: '2025-07-05T17:00:00.000Z' },
            { id: 2, name: 'Design UI/UX', description: 'Progettazione interfaccia utente e user experience', members: [2, 4], status: 'completed', startDate: '2025-07-06', endDate: '2025-07-12', progress: 100, difficulty: 3, createdAt: '2025-07-01T10:15:00.000Z', assignedAt: '2025-07-06T09:00:00.000Z', startedAt: '2025-07-06T09:30:00.000Z', completedAt: '2025-07-12T16:45:00.000Z' },
            { id: 3, name: 'Sviluppo Backend', description: 'Implementazione logica server e database', members: [1, 3, 5], status: 'progress', startDate: '2025-07-08', endDate: '2025-07-18', progress: 65, difficulty: 3, createdAt: '2025-07-01T10:30:00.000Z', assignedAt: '2025-07-08T08:00:00.000Z', startedAt: '2025-07-08T09:00:00.000Z' },
            { id: 4, name: 'Sviluppo Frontend', description: 'Sviluppo interfaccia utente responsive', members: [4, 1], status: 'progress', startDate: '2025-07-13', endDate: '2025-07-22', progress: 40, difficulty: 2, createdAt: '2025-07-01T10:45:00.000Z', assignedAt: '2025-07-13T09:00:00.000Z', startedAt: '2025-07-13T10:00:00.000Z' },
            { id: 5, name: 'Testing & QA', description: 'Test funzionali e controllo qualit√†', members: [6, 3], status: 'planning', startDate: '2025-07-19', endDate: '2025-07-25', progress: 0, difficulty: 2, createdAt: '2025-07-01T11:00:00.000Z', assignedAt: '2025-07-19T08:00:00.000Z' },
            { id: 6, name: 'Deployment', description: 'Rilascio in produzione e configurazione server', members: [5, 1, 7], status: 'planning', startDate: '2025-07-26', endDate: '2025-07-28', progress: 0, difficulty: 1, createdAt: '2025-07-01T11:15:00.000Z', assignedAt: '2025-07-26T08:00:00.000Z' },
            { id: 7, name: 'Marketing Launch', description: 'Strategia di lancio e campagne promozionali', members: [9, 2, 7], status: 'review', startDate: '2025-07-20', endDate: '2025-07-30', progress: 80, difficulty: 2, createdAt: '2025-07-01T11:30:00.000Z', assignedAt: '2025-07-20T09:00:00.000Z', startedAt: '2025-07-20T10:00:00.000Z' }
        ];

        // Variabili globali per i dati
        let teamMembers = [];
        let tasks = [];
        let deletedTasks = [];
        let nextMemberId = 11;
        let nextTaskId = 8;
        let currentRole = 'manager';
        let currentUser = null;
        let currentEditingMember = null;
        let currentEditingTask = null;

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const messageArea = document.getElementById('messageArea');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');

        // Sistema di persistenza con Google Apps Script
        async function saveDataToGoogleScript() {
            const data = {
                teamMembers: teamMembers,
                tasks: tasks,
                deletedTasks: deletedTasks,
                nextMemberId: nextMemberId,
                nextTaskId: nextTaskId,
                lastSaved: new Date().toISOString(),
                version: Date.now()
            };

            try {
                console.log('Salvando su Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'save', 
                        data: data 
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Dati salvati su Google Apps Script:', new Date().toLocaleString());
                        saveDataLocally(data);
                        return true;
                    } else {
                        throw new Error(result.error || 'Errore sconosciuto');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Errore salvataggio Google Apps Script:', error);
                return saveDataLocally(data);
            }
        }

        async function loadDataFromGoogleScript() {
            try {
                console.log('Caricando da Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.URL);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data && data.teamMembers) {
                        teamMembers = data.teamMembers || [...defaultMembers];
                        tasks = data.tasks || [...defaultTasks];
                        deletedTasks = data.deletedTasks || [];
                        nextMemberId = data.nextMemberId || 11;
                        nextTaskId = data.nextTaskId || 8;
                        
                        console.log('‚úÖ Dati caricati da Google Apps Script:', new Date().toLocaleString());
                        console.log('üìä Membri caricati:', teamMembers.length);
                        console.log('üìã Attivit√† caricate:', tasks.length);
                        
                        saveDataLocally(data);
                        return true;
                    } else {
                        throw new Error('Dati non validi ricevuti');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento Google Apps Script:', error);
                return loadDataLocally();
            }
        }

        function saveDataLocally(data) {
            try {
                const dataToSave = data || {
                    teamMembers: teamMembers,
                    tasks: tasks,
                    deletedTasks: deletedTasks,
                    nextMemberId: nextMemberId,
                    nextTaskId: nextTaskId,
                    lastSaved: new Date().toISOString()
                };
                
                const dataString = JSON.stringify(dataToSave);
                
                try {
                    if (typeof(Storage) !== "undefined" && localStorage) {
                        localStorage.setItem('teamManagerData', dataString);
                    }
                } catch(e) {
                    console.log('localStorage non disponibile');
                }
                
                console.log('Dati salvati localmente:', new Date().toLocaleString());
                return true;
            } catch (e) {
                console.error('Errore nel salvataggio locale:', e);
                return false;
            }
        }

        function loadDataLocally() {
            try {
                let dataString = null;
                
                try {
                    if (typeof(Storage) !== "undefined" && localStorage) {
                        dataString = localStorage.getItem('teamManagerData');
                    }
                } catch(e) {
                    console.log('localStorage non accessibile');
                }
                
                if (dataString) {
                    const data = JSON.parse(dataString);
                    teamMembers = data.teamMembers || [...defaultMembers];
                    tasks = data.tasks || [...defaultTasks];
                    deletedTasks = data.deletedTasks || [];
                    nextMemberId = data.nextMemberId || 11;
                    nextTaskId = data.nextTaskId || 8;
                    console.log('Dati caricati da storage locale');
                    return true;
                } else {
                    teamMembers = [...defaultMembers];
                    tasks = [...defaultTasks];
                    deletedTasks = [];
                    nextMemberId = 11;
                    nextTaskId = 8;
                    saveDataLocally();
                    console.log('Dati di default inizializzati');
                    return true;
                }
            } catch (e) {
                console.error('Errore nel caricamento locale:', e);
                teamMembers = [...defaultMembers];
                tasks = [...defaultTasks];
                deletedTasks = [];
                nextMemberId = 11;
                nextTaskId = 8;
                return false;
            }
        }

        async function saveData() {
            return await saveDataToGoogleScript();
        }

        async function loadData() {
            return await loadDataFromGoogleScript();
        }

        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }

        function hideMessage() {
            messageArea.style.display = 'none';
        }

        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            hideMessage();
            
            if (!username || !password) {
                showMessage('Inserisci username e password', 'error');
                return;
            }

            showMessage('Caricando dati...', 'success');
            
            loadData().then(() => {
                if (username === credentials.manager.username && password === credentials.manager.password) {
                    currentRole = 'manager';
                    currentUser = { username: username, role: 'manager', name: 'Admin Manager' };
                    loginSuccess();
                    return;
                }

                if (username === credentials.member.username && password === credentials.member.password) {
                    currentRole = 'member';
                    currentUser = { username: username, role: 'member', name: 'Team Member' };
                    loginSuccess();
                    return;
                }

                const member = teamMembers.find(m => m.username === username && m.password === password);
                if (member) {
                    currentRole = 'member';
                    currentUser = { 
                        username: username, 
                        role: 'member', 
                        name: `${member.firstName} ${member.lastName}`,
                        id: member.id,
                        avatar: member.avatar
                    };
                    loginSuccess();
                    return;
                }

                showMessage('Credenziali non valide. Controlla username e password.', 'error');
            }).catch(error => {
                console.error('Errore nel caricamento:', error);
                showMessage('Errore nel caricamento dati. Riprova.', 'error');
            });
        }

        function loginSuccess() {
            showMessage('Accesso effettuato con successo!', 'success');
                                
            setTimeout(() => {
                loginScreen.style.display = 'none';
                dashboardScreen.style.display = 'block';
                                        
                if (currentRole === 'manager') {
                    userDisplayName.textContent = currentUser.name;
                    userAvatar.textContent = 'AM';
                    document.querySelectorAll('.manager-only').forEach(section => {
                        section.classList.add('show');
                    });
                    document.querySelectorAll('.member-only').forEach(section => {
                        section.classList.remove('show');
                    });
                    document.getElementById('ganttSubtitle').textContent = 'Panoramica completa di tutte le attivit√† del team';
                } else {
                    userDisplayName.textContent = currentUser.name;
                    userAvatar.textContent = currentUser.avatar || 'TM';
                    document.querySelectorAll('.manager-only').forEach(section => {
                        section.classList.remove('show');
                    });
                    document.querySelectorAll('.member-only').forEach(section => {
                        section.classList.add('show');
                    });
                    document.getElementById('ganttSubtitle').textContent = 'Le tue attivit√† assegnate e quelle del team';
                }
                                        
                loadDashboard();
            }, 1000);
        }

        function logout() {
            dashboardScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            document.querySelectorAll('.manager-only').forEach(section => {
                section.classList.remove('show');
            });
            document.querySelectorAll('.member-only').forEach(section => {
                section.classList.remove('show');
            });
            currentUser = null;
            currentRole = 'manager';
        }

        function loadDashboard() {
            loadData().then(() => {
                loadGanttChart();
                if (currentRole === 'manager') {
                    loadTasksTable();
                    loadMembersTable();
                } else {
                    loadUserTasks();
                }
                updateStats();
                startPeriodicSync();
            }).catch(error => {
                console.error('Errore nel caricamento dashboard:', error);
                loadGanttChart();
                if (currentRole === 'manager') {
                    loadTasksTable();
                    loadMembersTable();
                } else {
                    loadUserTasks();
                }
                updateStats();
            });
        }

        function updateStats() {
            const totalTasks = tasks.length;
            const inProgress = tasks.filter(t => t.status === 'progress').length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const totalMembers = teamMembers.length;

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('totalMembers').textContent = totalMembers;
        }

        function generateDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
                        
            const current = new Date(start);
            while (current <= end) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function loadGanttChart() {
            const container = document.getElementById('ganttContainer');
            container.innerHTML = '';
            
            let visibleTasks = [...tasks];
            if (currentRole === 'member' && currentUser.id) {
                // I membri vedono tutte le attivit√† del team, con highlight sulle proprie
                visibleTasks = tasks;
            }
            
            if (visibleTasks.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #64748b;"><h3>üéâ Nessuna attivit√†!</h3><p>Non ci sono attivit√† da visualizzare.</p></div>';
                return;
            }
            
            const projectStart = new Date('2025-07-01');
            const projectEnd = new Date('2025-07-31');
            const dateRange = generateDateRange(projectStart, projectEnd);
            const dayWidth = 40;

            // Header
            const header = document.createElement('div');
            header.className = 'gantt-header';
            const taskColumn = document.createElement('div');
            taskColumn.className = 'gantt-task-column';
            taskColumn.textContent = 'Attivit√†';
            header.appendChild(taskColumn);

            const timelineHeader = document.createElement('div');
            timelineHeader.className = 'gantt-timeline-header';
            dateRange.forEach(date => {
                const dateCell = document.createElement('div');
                dateCell.className = 'gantt-date-cell';
                dateCell.style.minWidth = dayWidth + 'px';
                dateCell.textContent = `${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                timelineHeader.appendChild(dateCell);
            });
            header.appendChild(timelineHeader);
            container.appendChild(header);

            // Task rows
            visibleTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'gantt-row';

                const taskInfo = document.createElement('div');
                taskInfo.className = 'gantt-task-info';
                
                const taskName = document.createElement('div');
                taskName.className = 'task-name';
                taskName.textContent = task.name;

                const taskMembers = document.createElement('div');
                taskMembers.className = 'task-members';
                task.members.forEach(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    if (member) {
                        const memberTag = document.createElement('span');
                        memberTag.className = 'member-tag';
                        memberTag.textContent = member.avatar;
                        if (currentRole === 'member' && currentUser.id === memberId) {
                            memberTag.style.background = '#10b981';
                            memberTag.style.fontWeight = 'bold';
                        }
                        taskMembers.appendChild(memberTag);
                    }
                });

                // Checkbox per membri
                if (currentRole === 'member' && currentUser.id && task.members.includes(currentUser.id)) {
                    const taskControls = document.createElement('div');
                    taskControls.className = 'gantt-task-controls';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `gantt-task-${task.id}`;
                    checkbox.checked = task.status === 'completed';
                    checkbox.addEventListener('change', () => completeTask(task.id, checkbox.checked));
                    
                    const label = document.createElement('label');
                    label.htmlFor = `gantt-task-${task.id}`;
                    label.textContent = 'Completata';
                    label.className = 'task-checkbox';
                    
                    taskControls.appendChild(checkbox);
                    taskControls.appendChild(label);
                    taskInfo.appendChild(taskControls);
                }

                taskInfo.appendChild(taskName);
                taskInfo.appendChild(taskMembers);

                // Timeline
                const timeline = document.createElement('div');
                timeline.className = 'gantt-timeline';
                dateRange.forEach(date => {
                    const dateColumn = document.createElement('div');
                    dateColumn.className = 'gantt-date-column';
                    dateColumn.style.minWidth = dayWidth + 'px';
                    timeline.appendChild(dateColumn);
                });

                const taskStart = new Date(task.startDate);
                const taskEnd = new Date(task.endDate);
                const startOffset = Math.floor((taskStart - projectStart) / (1000 * 60 * 60 * 24));
                const duration = Math.floor((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1;

                const taskBar = document.createElement('div');
                taskBar.className = `gantt-bar progress-${task.status}`;
                taskBar.style.left = (startOffset * dayWidth + 5) + 'px';
                taskBar.style.width = (duration * dayWidth - 10) + 'px';
                taskBar.textContent = `${duration}g (${task.progress}%)`;
                taskBar.title = `${task.name}: ${task.startDate} - ${task.endDate}`;

                timeline.appendChild(taskBar);
                row.appendChild(taskInfo);
                row.appendChild(timeline);
                container.appendChild(row);
            });
        }

        function loadUserTasks() {
            if (!currentUser || !currentUser.id) return;
            
            const userTasks = tasks.filter(task => task.members.includes(currentUser.id));
            const container = document.getElementById('userTasksList');
            container.innerHTML = '';

            if (userTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;"><h3>üìù Nessuna attivit√† assegnata</h3><p>Al momento non hai attivit√† assegnate.</p></div>';
                return;
            }

            const statusLabels = {
                'planning': 'Pianificazione',
                'progress': 'In Corso',
                'completed': 'Completata',
                'review': 'In Revisione'
            };

            userTasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `user-task-card ${task.status === 'completed' ? 'completed' : ''}`;
                
                taskCard.innerHTML = `
                    <div class="task-card-header">
                        <div>
                            <div class="task-card-title">${task.name}</div>
                        </div>
                        <span class="task-card-status status-${task.status}">${statusLabels[task.status]}</span>
                    </div>
                    <div class="task-card-description">${task.description}</div>
                    <div class="task-card-info">
                        <div class="task-info-item">
                            <div class="task-info-label">Data Inizio</div>
                            <div class="task-info-value">${formatDate(task.startDate)}</div>
                        </div>
                        <div class="task-info-item">
                            <div class="task-info-label">Data Fine</div>
                            <div class="task-info-value">${formatDate(task.endDate)}</div>
                        </div>
                        <div class="task-info-item">
                            <div class="task-info-label">Progresso</div>
                            <div class="task-info-value">${task.progress}%</div>
                        </div>
                        <div class="task-info-item">
                            <div class="task-info-label">Difficolt√†</div>
                            <div class="task-info-value">${'‚≠ê'.repeat(task.difficulty)}</div>
                        </div>
                    </div>
                    <div class="completion-checkbox">
                        <input type="checkbox" id="task-${task.id}" ${task.status === 'completed' ? 'checked' : ''} onchange="completeTask(${task.id}, this.checked)">
                        <label for="task-${task.id}">Marca come completata</label>
                    </div>
                `;
                
                container.appendChild(taskCard);
            });
        }

        function completeTask(taskId, isCompleted) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                if (isCompleted) {
                    task.status = 'completed';
                    task.progress = 100;
                    task.completedAt = new Date().toISOString();
                } else {
                    task.status = 'progress';
                    task.progress = Math.max(0, task.progress - 10);
                    task.completedAt = null;
                }
                
                // Salva i dati
                saveData();
                
                // Ricarica le viste
                loadGanttChart();
                if (currentRole === 'member') {
                    loadUserTasks();
                }
                if (currentRole === 'manager') {
                    loadTasksTable();
                }
                updateStats();
                
                showMessage(isCompleted ? 'Attivit√† completata!' : 'Attivit√† riaperta!', 'success');
                setTimeout(hideMessage, 3000);
            }
        }

        // === GESTIONE MEMBRI ===
        function openAddMemberModal() {
            currentEditingMember = null;
            document.getElementById('modalTitle').textContent = 'Aggiungi Nuovo Membro';
            document.getElementById('memberFirstName').value = '';
            document.getElementById('memberLastName').value = '';
            document.getElementById('memberUsername').value = '';
            document.getElementById('memberPassword').value = '';
            showModal('memberModal');
        }

        function editMember(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            if (member) {
                currentEditingMember = member;
                document.getElementById('modalTitle').textContent = 'Modifica Membro';
                document.getElementById('memberFirstName').value = member.firstName;
                document.getElementById('memberLastName').value = member.lastName;
                document.getElementById('memberUsername').value = member.username;
                document.getElementById('memberPassword').value = member.password || 'pass123';
                showModal('memberModal');
            }
        }

        function deleteMember(memberId) {
            if (confirm('Sei sicuro di voler eliminare questo membro?')) {
                teamMembers = teamMembers.filter(m => m.id !== memberId);
                // Rimuovi il membro da tutte le attivit√†
                tasks.forEach(task => {
                    task.members = task.members.filter(id => id !== memberId);
                });
                
                saveData();
                loadMembersTable();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Membro eliminato con successo!', 'success');
                setTimeout(hideMessage, 3000);
            }
        }

        function saveMemberData() {
            const firstName = document.getElementById('memberFirstName').value.trim();
            const lastName = document.getElementById('memberLastName').value.trim();
            const username = document.getElementById('memberUsername').value.trim();
            const password = document.getElementById('memberPassword').value.trim();

            if (!firstName || !lastName || !username || !password) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }

            // Controlla username duplicato
            const existingMember = teamMembers.find(m => m.username === username && (!currentEditingMember || m.id !== currentEditingMember.id));
            if (existingMember) {
                showMessage('Username gi√† esistente', 'error');
                return;
            }

            if (currentEditingMember) {
                // Modifica membro esistente
                currentEditingMember.firstName = firstName;
                currentEditingMember.lastName = lastName;
                currentEditingMember.username = username;
                currentEditingMember.password = password;
                currentEditingMember.avatar = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                currentEditingMember.modifiedAt = new Date().toISOString();
                showMessage('Membro modificato con successo!', 'success');
            } else {
                // Nuovo membro
                const newMember = {
                    id: nextMemberId++,
                    firstName,
                    lastName,
                    username,
                    password,
                    avatar: (firstName.charAt(0) + lastName.charAt(0)).toUpperCase(),
                    createdAt: new Date().toISOString()
                };
                teamMembers.push(newMember);
                showMessage('Nuovo membro aggiunto con successo!', 'success');
            }

            saveData();
            closeMemberModal();
            loadMembersTable();
            updateStats();
            setTimeout(hideMessage, 3000);
        }

        function loadMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';

            teamMembers.forEach(member => {
                const assignedTasks = tasks.filter(task => task.members.includes(member.id)).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="member-tag">${member.avatar}</div>
                            <strong>${member.firstName} ${member.lastName}</strong>
                        </div>
                    </td>
                    <td>${member.username}</td>
                    <td>${assignedTasks} attivit√†</td>
                    <td>
                        <button class="btn btn-primary" onclick="editMember(${member.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteMember(${member.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // === GESTIONE ATTIVIT√Ä ===
        function openAddTaskModal() {
            currentEditingTask = null;
            document.getElementById('taskModalTitle').textContent = 'Nuova Attivit√†';
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskEndDate').value = '';
            
            // Reset difficulty selector
            document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
            
            // Reset members selector
            loadMembersSelector();
            showModal('taskModal');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                currentEditingTask = task;
                document.getElementById('taskModalTitle').textContent = 'Modifica Attivit√†';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('taskStartDate').value = task.startDate;
                document.getElementById('taskEndDate').value = task.endDate;
                
                // Set difficulty
                document.querySelectorAll('.difficulty-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (parseInt(opt.dataset.difficulty) === task.difficulty) {
                        opt.classList.add('selected');
                    }
                });
                
                loadMembersSelector(task.members);
                showModal('taskModal');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Sei sicuro di voler eliminare questa attivit√†?')) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.deletedAt = new Date().toISOString();
                    deletedTasks.push(task);
                }
                tasks = tasks.filter(t => t.id !== taskId);
                
                saveData();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Attivit√† eliminata con successo!', 'success');
                setTimeout(hideMessage, 3000);
            }
        }

        function saveTaskData() {
            const name = document.getElementById('taskName').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            
            const selectedDifficulty = document.querySelector('.difficulty-option.selected');
            const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox input:checked')).map(cb => parseInt(cb.value));

            if (!name || !description || !startDate || !endDate || !selectedDifficulty || selectedMembers.length === 0) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('La data di inizio deve essere precedente alla data di fine', 'error');
                return;
            }

            const difficulty = parseInt(selectedDifficulty.dataset.difficulty);

            if (currentEditingTask) {
                // Modifica attivit√† esistente
                currentEditingTask.name = name;
                currentEditingTask.description = description;
                currentEditingTask.startDate = startDate;
                currentEditingTask.endDate = endDate;
                currentEditingTask.difficulty = difficulty;
                currentEditingTask.members = selectedMembers;
                currentEditingTask.modifiedAt = new Date().toISOString();
                showMessage('Attivit√† modificata con successo!', 'success');
            } else {
                // Nuova attivit√†
                const newTask = {
                    id: nextTaskId++,
                    name,
                    description,
                    startDate,
                    endDate,
                    difficulty,
                    members: selectedMembers,
                    status: 'planning',
                    progress: 0,
                    createdAt: new Date().toISOString(),
                    assignedAt: new Date().toISOString()
                };
                tasks.push(newTask);
                showMessage('Nuova attivit√† creata con successo!', 'success');
            }

            saveData();
            closeTaskModal();
            loadTasksTable();
            loadGanttChart();
            updateStats();
            setTimeout(hideMessage, 3000);
        }

        function loadMembersSelector(selectedMembers = []) {
            const container = document.getElementById('membersSelector');
            container.innerHTML = '';

            teamMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-checkbox';
                
                const isSelected = selectedMembers.includes(member.id);
                memberDiv.innerHTML = `
                    <input type="checkbox" value="${member.id}" ${isSelected ? 'checked' : ''}>
                    <div class="member-checkbox-avatar">${member.avatar}</div>
                    <span>${member.firstName} ${member.lastName}</span>
                `;
                container.appendChild(memberDiv);
            });
        }

        function loadTasksTable() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            const statusLabels = {
                'planning': 'PIANIFICAZIONE',
                'progress': 'IN CORSO',
                'completed': 'COMPLETATA',
                'review': 'IN REVISIONE'
            };

            tasks.forEach(task => {
                const memberTags = task.members.map(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    return member ? `<span class="member-tag">${member.avatar}</span>` : '';
                }).join(' ');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${task.name}</strong><br>
                        <small>${task.description}</small>
                    </td>
                    <td>${memberTags}</td>
                    <td>${formatDate(task.startDate)} - ${formatDate(task.endDate)}</td>
                    <td><span class="status-${task.status}">${statusLabels[task.status]}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="editTask(${task.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // === GESTIONE MODALI ===
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        function closeMemberModal() {
            const modal = document.getElementById('memberModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // === UTILITY FUNCTIONS ===
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function refreshData() {
            showMessage('Aggiornando dati...', 'success');
            loadData().then(() => {
                loadGanttChart();
                if (currentRole === 'manager') {
                    loadTasksTable();
                    loadMembersTable();
                } else {
                    loadUserTasks();
                }
                updateStats();
                showMessage('Dati aggiornati!', 'success');
                setTimeout(hideMessage, 2000);
            });
        }

        function exportToExcel() {
            // Implementazione esportazione Excel
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Nome,Descrizione,Membri,Data Inizio,Data Fine,Stato,Progresso\n"
                + tasks.map(task => {
                    const memberNames = task.members.map(id => {
                        const member = teamMembers.find(m => m.id === id);
                        return member ? `${member.firstName} ${member.lastName}` : '';
                    }).join('; ');
                    return `"${task.name}","${task.description}","${memberNames}","${task.startDate}","${task.endDate}","${task.status}","${task.progress}%"`;
                }).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `team_manager_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Dati esportati con successo!', 'success');
            setTimeout(hideMessage, 3000);
        }

        function startPeriodicSync() {
            // Sincronizzazione automatica ogni 5 minuti
            setInterval(() => {
                saveData();
            }, 5 * 60 * 1000);
        }

        // === EVENT LISTENERS ===
        loginButton.addEventListener('click', handleLogin);
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });

        // Difficulty selector
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('difficulty-option')) {
                document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeMemberModal();
                closeTaskModal();
            }
        });

        // Quick login demo buttons
        function quickLogin(role) {
            if (role === 'manager') {
                usernameInput.value = 'admin';
                passwordInput.value = 'Olbia2025@';
            } else {
                usernameInput.value = 'user';
                passwordInput.value = 'team456';
            }
            handleLogin();
        }

        // Aggiungi pulsanti demo rapidi
        document.addEventListener('DOMContentLoaded', function() {
            const demoInfo = document.querySelector('.demo-info');
            const quickButtons = document.createElement('div');
            quickButtons.style.marginTop = '15px';
            quickButtons.innerHTML = `
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="quickLogin('manager')" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Login Manager</button>
                    <button onclick="quickLogin('member')" style="flex: 1; padding: 8px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Login Membro</button>
                </div>
            `;
            demoInfo.appendChild(quickButtons);
            
            // Inizializza con dati di default se necessario
            if (teamMembers.length === 0) {
                loadDataLocally();
            }
        });

        // Inizializza con statistiche aggiornate
        updateStats();
    </script>
</body>
</html>